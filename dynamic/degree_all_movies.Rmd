---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
library(openxlsx)
library(stringr)
library(dplyr)
library(reshape2)
library(igraph)
library(R.matlab)
path ="D:/allGroups/Females_Mated"
setwd(path)
number_of_flys<-10
number_of_frame<-1
facade<-FALSE

#seq by the  number of frames
numbers<-seq(1, 27001, by=number_of_frame)

f <- function(x) {
    if(is.list(x)) lapply(x, f)
    else ifelse(length(x) == 0, 0, x)
}



dir<-list.dirs(recursive = F,path = path)

for(num_of_movie in 1:length(dir)){
  #if the file don't exist ,creat him
  if(!file.exists(paste0(dir[num_of_movie], '/','all_frames_degree.csv'))){
  print(dir[num_of_movie])
    print("creating the file of this dir")
  #it is under the assumtion that there is 10 flys and they are orgenized in spcific way from the Allinteraction.mat
  mat <- (readMat(paste0(dir[num_of_movie], '/','Allinteraction.mat'))) # read each MAT file
  sub_list_mat<-matrix(mat[["new.interactionFrameMatrix"]],nrow = number_of_flys, ncol = number_of_flys)
  df_mat<-as.data.frame(sub_list_mat)
  

  
  
  
    #REMOVE 0 (MEAN NO INTERACTION)
  for(i in 1:ncol(df_mat)){
    for(j in 1:nrow(df_mat)){
      if(length(unlist(df_mat[i,j])) == 0){
        df_mat[i,j] <- lapply(df_mat[i,j], function(x)x[lengths(x) == 0] <- 0)
      }
    }
  }
  
  df_mat<-na.omit(df_mat)

  

  #10 flys
  colnames(df_mat)<-c("1","2","3","4","5","6","7","8","9","10")
  rownames(df_mat)<-c("1","2","3","4","5","6","7","8","9","10")
  nodes<-c("1","2","3","4","5","6","7","8","9","10")
  nodes<-as.data.frame(nodes)
  all<-data.frame()
  
  for(i in 1:number_of_flys){
    for(j in 1:number_of_flys){
      if(length(unlist(sub_list_mat[i,j]))!=0){
        temp_num_frames<-unlist(df_mat[i,j])
        tobind<-c(colnames(df_mat[i]),rownames(df_mat[j,]))
        tobind<-as.data.frame(t(tobind))
        #the value from where the diffrence is bigger than 120 in the next frame
        seq_inter<- temp_num_frames[diff(temp_num_frames)>120]
        if(length(seq_inter)> 0){
          num_of_seq_iter<-length(seq_inter)
          current_iindex<-1
          for(k in 1:num_of_seq_iter){
            tobind<-c(colnames(df_mat[i]),rownames(df_mat[j,]))
            tobind<-as.data.frame(t(tobind))
            
            index<-which(temp_num_frames == seq_inter[k])
            tt_temp_num_frames<-as.data.frame(temp_num_frames)
            temp_all_inter<-tt_temp_num_frames[current_iindex:index,]
            current_iindex<-index+1
            tobind<-cbind(tobind,temp_all_inter[1])
            tobind<-cbind(tobind,temp_all_inter[length(temp_all_inter)])
            colnames(tobind)<-c("tail","head","onset","terminus")
            
            all<-rbind(all,tobind)
        }
        
        }else{
          tobind<-cbind(tobind,temp_num_frames[1])
          tobind<-cbind(tobind,temp_num_frames[length(temp_num_frames)])
          colnames(tobind)<-c("tail","head","onset","terminus")
          all<-rbind(all,tobind)
          
        }
        
      }
        
    }
  }
  
  colnames(all)<-c("tail","head","onset","terminus")
  
  all["head"] <- as.numeric(unlist(all["head"]))
  all["tail"] <- as.numeric(unlist(all["tail"]))
  
  
  
  
  
  all<-cbind(all,1)
  value_sum_df<-data.frame()
  data<-data.frame()
  temp_between_values<-c()

for(i in 1:(length(numbers)-1)){
  temp_between_values<-c()
  #find those that are bigger than the onset and small from the terminus
  temp_between_values<-all %>% filter(numbers[i+1]>=onset & numbers[i] <=terminus)
  if( nrow(temp_between_values)!=0){
    #changing the format to get "matrix" with who is in interaction with who
  values<-acast(temp_between_values, tail~head,fun.aggregate=sum)
  #creat matrix in the size of 10 on 10 with 0 
  zero_matrix <- matrix(0, ncol = 10, nrow = 10)
  #all_values conation who is in intartcion with who in the spcific frame
  all_values<-acast(rbind(melt(values), melt(zero_matrix)), Var1~Var2, sum)
  net2 <- graph_from_adjacency_matrix(all_values,mode = "undirected")
  #creat a degree 
  deg <- degree(net2)
  value_sum_temp<-data.frame(begin=numbers[i],end=numbers[i+1],degree=(sum(deg)/2))
  value_sum_df<- bind_rows(value_sum_df,value_sum_temp)
  }else{
  value_sum_temp<-data.frame(begin=numbers[i],end=numbers[i+1],degree=0)
  value_sum_df<- bind_rows(value_sum_df,value_sum_temp)
  }
  }
  
#the else is to get the whole frame on interaction so we see the buildup
data<- as.data.frame(paste0(value_sum_df$begin,"-", value_sum_df$end))
data$value<-value_sum_df$degree
colnames(data)<-c("Frame","Value")


data$Frame <- as.character(data$Frame)
#Then turn it back into a factor with the levels in the correct order
#data$Frame<-as.factor(data$Frame)
#data$Frame <- factor(data$Frame, levels=unique(data$Frame))
data$group<-as.character(num_of_movie)
#data$group <- factor(data$group, levels=unique(data$group))

write.csv(data,paste0(dir[num_of_movie], '/','all_frames_degree.csv'), row.names = TRUE)

}
#if(num_of_movie==1){
 # total_data_for_Graph<-data
#}else{
 # total_data_for_Graph<-cbind(total_data_for_Graph,data)
#}



#total_data_for_Graph$group <- factor(total_data_for_Graph$group, levels=unique(total_data_for_Graph$group))


}

test<-read.csv("D:/allGroups/Females_Mated/Assa_Female_Mated_Unknown_RigA_20211025T120646/all_frames_degree.csv")

avarge_per_frames<-aggregate(total_data_for_Graph[,2], list(total_data_for_Graph$Frame), mean)

colnames(avarge_per_frames)<-c("Frame","Value")

#title
title_of_plot<-paste0(basename(path)," plot of dgree in each ",number_of_frame," frames_without angelsub")



if(facade==FALSE){
  library(ggplot2)

p<-ggplot()+geom_line(data = total_data_for_Graph, mapping = aes(x = Frame, y = Value,group=group,color=group)) +geom_point(data=avarge_per_frames, aes(x=Frame, y=Value), color='red', size = 3,alpha = 0.15)


 p<-p+theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +ggtitle(title_of_plot) +
  xlab("frames") + ylab("dgree(sum)") +theme(
plot.title = element_text(color="red", size=7, face="bold.italic"),
axis.title.x = element_text(color="blue", size=7, face="bold"),
axis.title.y = element_text(color="#993333", size=7, face="bold")
) + ylim(0, 45)
 
 

 plot(p)
  
 name_for_file<-paste0(basename(path),number_of_frame,"_frames_all_movies_sum_degree_without_angelsub.pdf")

ggsave(filename = name_for_file,device="pdf",path="C:/Users/barakli8/OneDrive - Bar Ilan University/Lital/weekly presentation/pics_for_degree")
 

}else{
  
library(ggplot2)

p<-ggplot()+geom_line(data = total_data_for_Graph, mapping = aes(x = Frame, y = Value,group=group,color=group))


p<-p + facet_wrap(  ~ group)


 p<-p+theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +ggtitle(title_of_plot) +
  xlab("frames") + ylab("dgree(sum)") +theme(
plot.title = element_text(color="red", size=7, face="bold.italic"),
axis.text.x=element_blank(),axis.ticks.x=element_blank(),
axis.title.y = element_text(color="#993333", size=7, face="bold")
) + ylim(0, 45)
 
plot(p)


 name_for_file<-paste0(basename(path),number_of_frame,"_frames_all_movies_sum_degree_each_movie_without_angelsub.pdf")

ggsave(filename = name_for_file,device="pdf",path="C:/Users/barakli8/OneDrive - Bar Ilan University/Lital/weekly presentation/pics_for_degree")
}

 #library(ggplot2)

# ggplot(avarge_per_frames,aes(x=Frame,y=Value))+geom_point()


 

```




#creat graph for one movie in perframe

```{r}
test<-read.csv("D:/allGroups/Females_Mated/Assa_Female_Mated_Unknown_RigA_20211025T120646/all_frames_degree.csv")


all_features<-read.csv("D:/allGroups/Females_Mated/Assa_Female_Mated_Unknown_RigA_20211025T120646/perframe_sum_allflies.csv")
sum_per_frames<-test[,c(1,3)]
colnames(sum_per_frames)<-c("Frame","Value")

#title
title_of_plot<-paste0(basename(path)," plot of dgree in each ",number_of_frame," frames_without angelsub")

all_features_new<-all_features[1:27000,]

data<-cbind(all_features_new,sum_per_frames$Value)

data_cor <- cor(data[ , colnames(data) != "Value"],  # Calculate correlations
                data$Value)
data_cor  
library(corrplot)
corrplot(data_cor, method="circle",tl.cex = 0.5)
corrplot(data_cor, type="upper", order="hclust", tl.col="black", tl.srt=45,tl.cex = 0.4)


#png(filename = "mycorrplot.png", width = 1200, height = 800)
corrplot(data_cor, method="circle", addCoef.col = 1, tl.cex = 0.5)
#dev.off()

  library(ggplot2)

p<-ggplot()+geom_line(data = sum_per_frames, mapping = aes(x = Frame, y = Value))
plot(p)


 
```
correlaction

```{r}



test<-read.csv("D:/allGroups/Females_Mated/Assa_Female_Mated_Unknown_RigA_20211025T120646/all_frames_degree.csv")


all_features<-read.csv("D:/allGroups/Females_Mated/Assa_Female_Mated_Unknown_RigA_20211025T120646/perframe_sum_allflies.csv")
sum_per_frames<-test[,c(1,3)]
colnames(sum_per_frames)<-c("Frame","degree")

library(stringr)



all_features_new<-all_features[1:27000,]


colnames(all_features_new)<-str_remove(colnames(all_features_new), ".mat")

data<-cbind(all_features_new,sum_per_frames$degree)



data_cor <- cor(data[ , colnames(data) != "degree"],  # Calculate correlations
                data$degree)
data_cor  

cor(data)
library(corrplot)
corrplot(data_cor, method="circle",tl.cex = 0.5)
corrplot(data_cor, type="upper", order="hclust", tl.col="black", tl.srt=45,tl.cex = 0.4)


png(filename = "C:/Users/barakli8/OneDrive - Bar Ilan University/Lital/weekly presentation/8.06/mycorrplot.png", width = 1200, height = 800)
corrplot(data_cor, method="circle", addCoef.col = 1, tl.cex = 0.5)
#dev.off()


#In this example, Iâ€™ll demonstrate how to get the Pearson correlation coefficient between a particular data frame variable with all the other variables in this data frame.



#In order to reduce the sheer quantity of variables (without having to manually pick and choose), Only variables above a specific significance level threshold are selected. It is set to 0.5 as the initial default.

library(dplyr)
corr_simple <- function(data=df,sig=0.4){
  #convert data to numeric in order to run correlations
  #convert to factor first to keep the integrity of the data - each value will become a number rather than turn into NA
  df_cor <- data %>% mutate_if(is.character, as.factor)
  df_cor <- df_cor %>% mutate_if(is.factor, as.numeric)
  #run a correlation and drop the insignificant ones

  #corr <- cor(df_cor[ , colnames(df_cor) != "degree"],  # Calculate correlations
   #             df_cor$degree) 
  
  corr<-cor(df_cor)
  #prepare to drop duplicates and correlations of 1     
  corr[lower.tri(corr,diag=TRUE)] <- NA 
  #drop perfect correlations
  corr[corr == 1] <- NA 
  #turn into a 3-column table
  corr <- as.data.frame(as.table(corr))
  #remove the NA values from above 
  corr <- na.omit(corr) 
  #select significant values  
  corr <- subset(corr, abs(Freq) > sig) 
  #sort by highest correlation
  corr <- corr[order(-abs(corr$Freq)),] 
  #print table
  print(corr)
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  
  #plot correlations visually
  png(filename = "C:/Users/barakli8/OneDrive - Bar Ilan University/Lital/weekly presentation/8.06/mycorrplot.png", width = 1200, height = 800)
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ",tl.cex = 0.55)
}
corr_simple(data)







res <- cor(data)


# Get some colors
col<- colorRampPalette(c("blue", "white", "red"))(80)
heatmap(x = res, col = col, symm = TRUE)








corr_mat <- round(cor(data),2) 
head(corr_mat)

# Install and load reshape2 package
library(reshape2)

# creating correlation matrix
corr_mat <- round(cor(data),2)

# reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)
# head(melted_corr_mat)

# plotting the correlation heatmap
library(ggplot2)
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2,
								fill=value)) +
geom_tile()

# Code to plot a reorederd heatmap

# Install and load reshape2 package
library(reshape2)

# creating correlation matrix
corr_mat <- round(cor(data),2)

# reorder corr matrix
# using corr coefficient as distance metric
dist <- as.dist((1-corr_mat)/2)

# hierarchical clustering the dist matrix
hc <- hclust(dist)
corr_mat <-corr_mat[hc$order, hc$order]

# reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)
#head(melted_corr_mat)

#plotting the correlation heatmap
library(ggplot2)
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value)) +
geom_tile()



# Load and install heatmaply package
library(heatmaply)

# plotting corr heatmap
heatmaply_cor(x = cor(data), xlab = "Features",
			ylab = "Features", k_col = 2, k_row = 2)






```




```{r}

library(lubridate)


my_t = ts(data[,1:2])

my_t = ts(s, start = c(2019,1), frequency = 19)


plot(aggregate(my_t), type="p", pch=20, cex=3, ylab="Aggregate per time unit")

```

```{r}


set.seed(9797)
s_1 = seq(221:256)

# A cyclic vector for SEASONAL variations.
s_2 = cos(seq(from=1/12*pi, to=6*pi, by=(6*pi/36)))*5

# Random numbers for errors (white noise).
set.seed(65)
s_3 = rnorm(36)

# The data vector.
s = s_1 + s_2 + s_3

# The time series object is created.
my_t = ts(s, start = c(2019,1), frequency = 12)

# Plot the time series.
plot(my_t, ylab = "Values")
```

```{r}
xts(data$Value, as.Date(data$Frame))



 library(zoo)
 #ZOO <- zoo(data$Value, as.character(data$Frame))
 ZOO <- zoo(data$Value)

 my_t<-ts(ZOO,frequency = 2700)
 plot(my_t)
 
 
plot(aggregate(my_t), type="p", pch=20, cex=3, ylab="Aggregate per time unit")

library(lubridate)

library(forecast)

my_vec<-as.vector(data$Value)
myts <- ts(my_vec, start=c(1, 1), frequency=2700)


 plot(myts)
 fit <- stl(myts, s.window="period")

plot(fit)

fit <- auto.arima(my_t)
forecast(fit, 20)


plot(forecast(fit, 2000))
```

