---
title: "rf_cyp"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



```{r}
require(R.matlab)
library(base)
library(openxlsx)
library(igraph)
library(ggplot2)
library(cowplot)
library(ggpubr)
library(ggsignif)
library(nortest)
library(fmsb)
library(argparser, quietly=TRUE)
library(stringr)
library("readxl")

test = FALSE

group_name<-c()
num_of_pop<-0
colors_of_groups<<-data.frame()

groupsNames <<- c()
xlsxFile<<-c()




#to debug if i want to run and see the var
if (test == TRUE){
  
  p <- arg_parser("path of the color")
  
  # Add command line arguments
  p <- add_argument(p,"path",
                    help = "path",
                    flag = FALSE)
  
  # Parse the command line arguments
  argv <- parse_args(p)
  
}

###########################################################

if(test==TRUE){
  #reading from the path the color values
  dirs <- read.xlsx(argv$path)
  num_of_pop<<-nrow(dirs)
  
}else{
  #test for myself
  library(openxlsx)
  dirs <- as.data.frame(read.xlsx("F:/new_cyp6a20/dirs.xlsx"))
  num_of_pop<<-nrow(dirs)
}

#the path that have all the scripts in
path_to_scripts<-"C:/Users/lital/OneDrive - Bar Ilan University/Lital/code/interactions_network/randfor/sub_function"




#creat list of dirs 
dir=as.data.frame(lapply(structure(.Data=1:1,.Names=1:1),function(x) numeric(num_of_pop)))
for (i in 1:num_of_pop){
  dir[i,1]<-dirs$groupNameDir[i]
}
#xlsxFile <<- choose.files(default = "", caption = "Select expData file")

groupsNames <<- as.character(basename(dirs$groupNameDir))

#chnage the dir values so it would be readable
dir$X1<-gsub("\\\\", "/", dir$X1)
for(i in 1:num_of_pop){
  dir[i,1]<-str_trim(dir[i,1], side = c("right"))
}


#### run the functions

setwd(path_to_scripts)
files.sources = list.files()
sapply(files.sources, source)


#### the actuall run (if the user choose to run from the start)
for (i in 1:num_of_pop){
  #for each population i get the group name the number for movies and running 
  setwd(dir[i,1])
  avg_per_Fly_all_features(dir[i,1],path_to_scripts)
  importClassifierFilesAndCalculatePerFrame(dir[i,1],path_to_scripts)
  frq(dir[i,1],path_to_scripts)
}


#for (i in 1:num_of_pop){
#group_name <<- tools::file_path_sans_ext(basename((dir[i,1])))
#creatNetwork2popforscatter(dir[i,1])
#}


for(i in 1:num_of_pop){
  #for each net there is different valus 
  setwd(dir[i,1])
  combind_all(dir[i,1],path_to_scripts)
}


library("dplyr")
library("stringr")

ten<-data.frame()
twenty<-data.frame()
thirty<-data.frame()
forty<-data.frame()
fifty<-data.frame()



#feature_names<-all_features %>%
# select(-ends_with('~'))
ten_index<-0
twenty_index<-0
thirty_index<-0
forty_index<-0
fifty_index<-0

for(i in 1:num_of_pop){
  if(str_detect(basename(dir[i,1]), "ten")){
    ten_index<-ten_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    
    #test<-all_features_valus[,!grepl("*~",names(all_features_valus))]
    #connecting the names of the movies to the value and feature name
    
    #all_features_names<-cbind(all_features_names,all_features_valus[,!grepl("*~",names(all_features_valus))])
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("ten")
    if(ten_index==1){
      ten<-all_features_names
    }else{
      ten<-rbind(ten,all_features_names)
      
    }
    #putting factor on the label
    ten$id<-as.factor(ten$id)
  }
  if(str_detect(basename(dir[i,1]), "twenty")){
    twenty_index<-twenty_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    #connecting the names of the movies to the value and feature name
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("twenty")
    
    if(twenty_index==1){
      twenty<-all_features_names
    }else{
      twenty<-rbind(twenty,all_features_names)
      
    }
    #putting factor on the label
    twenty$id<-as.factor(twenty$id)
  }
  if(str_detect(basename(dir[i,1]), "thirty")){
    thirty_index<-thirty_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    #connecting the names of the movies to the value and feature name
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("thirty")
    
    if(thirty_index==1){
      thirty<-all_features_names
    }else{
      thirty<-rbind(thirty,all_features_names)
      
    }
    #putting factor on the label
    thirty$id<-as.factor(thirty$id)
  }
  if(str_detect(basename(dir[i,1]), "forty")){
    forty_index<-forty_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    #connecting the names of the movies to the value and feature name
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("forty")
    
    if(forty_index==1){
      forty<-all_features_names
    }else{
      forty<-rbind(forty,all_features_names)
      
    }
    #putting factor on the label
    forty$id<-as.factor(forty$id)
  }
  if(str_detect(basename(dir[i,1]), "fifty")){
    fifty_index<-fifty_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    #connecting the names of the movies to the value and feature name
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("fifty")
    
    if(fifty_index==1){
      fifty<-all_features_names
    }else{
      fifty<-rbind(fifty,all_features_names)
      
    }
    #putting factor on the label
    fifty$id<-as.factor(fifty$id)
  }


}
all_feature_final<-rbind(ten,twenty)
all_feature_final<-rbind(all_feature_final,thirty)
all_feature_final<-rbind(all_feature_final,forty)
all_feature_final<-rbind(all_feature_final,fifty)


#this part was problematic for the random forest
colnames(all_feature_final) <- make.names(colnames(all_feature_final))



```




```{r}
library(randomForest)
set.seed(71)
rf <-randomForest(id ~ .,data=all_feature_final) 
print(rf)




set.seed(71)
rf <-randomForest(id~.,data=all_feature_final, importance=TRUE,ntree=500)
print(rf)
importance(rf)
varImpPlot(rf)
```



```{r}


library(tidyverse)
library(dplyr) 
library(tidymodels)
library(class)
library(lazy)
library(logisticPCA)
library(ggplot2)
library(rARPACK)
library(e1071)
set.seed(123)



rf_mod<-rand_forest(trees = 1000)%>%set_engine("ranger")%>%set_mode("classification")

rf_fit<-rf_mod%>%fit(id ~ .,data = all_feature_final)

rf_fit





set.seed(345)
cell_folds <- vfold_cv(all_feature_final, v = 5)
cell_folds



tune_spec <- #here we are just defining the parameters for the decision tree
  decision_tree(
    cost_complexity = tune(),
    tree_depth = tune()
  ) %>% 
  set_engine("rpart") %>% 
  set_mode("classification")

tune_spec

tree_grid <- grid_regular(cost_complexity(),
                          tree_depth(),
                          levels = 10)

tree_grid

tree_grid %>% 
  count(tree_depth)




set.seed(345)

tree_wf <- workflow() %>% #defile the workflow
  add_model(tune_spec) %>%
  add_formula(id ~ .)

tree_res <- 
  tree_wf %>% 
  tune_grid(
    resamples = cell_folds,
    grid = tree_grid
  )

tree_res

tree_res %>% 
  collect_metrics()


tree_res %>%
  collect_metrics() %>%
  mutate(tree_depth = factor(tree_depth)) %>%
  ggplot(aes(cost_complexity, mean, color = tree_depth)) +
  geom_line(size = 1.5, alpha = 0.6) +
  geom_point(size = 2) +
  facet_wrap(~ .metric, scales = "free", nrow = 2) +
  scale_x_log10(labels = scales::label_number()) +
  scale_color_viridis_d(option = "plasma", begin = .9, end = 0)


best_tree <- tree_res %>%
  select_best("roc_auc") #Selecting the best tree

best_tree

final_wf <- 
  tree_wf %>% 
  finalize_workflow(best_tree)

final_wf


final_tree <- 
  final_wf %>%
  fit(data = all_feature_final) 

final_tree

library(vip)
final_tree %>% 
  pull_workflow_fit() %>% 
  vip()

final_tree %>% 
  extract_fit_parsnip() %>% 
  vip()
```

