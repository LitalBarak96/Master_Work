---
title: "Untitled"
author: "lital barak"
date: "2022-09-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r}


debbug_path_color<-"D:/EX5_6/color.xlsx"
file.exists(debbug_path_color)


if(file.exists(debbug_path_color)){
    library(stringr)
  library(openxlsx)
  dirs <- as.data.frame(read.xlsx(debbug_path_color))
  num_of_pop<<-nrow(dirs)
}else{
  stop("worng paths change please to what needed")
}
#all groupes

  
  
  dir=as.data.frame(lapply(structure(.Data=1:1,.Names=1:1),function(x) X = numeric(num_of_pop)))
for (i in 1:num_of_pop){
  dir[i,1]<-dirs$groupNameDir[i]
}

groupsNames <<- as.character(basename(dirs$groupNameDir))

#chnage the dir values so it would be readable
dir$X1<-gsub("\\\\", "/", dir$X1)
for(i in 1:num_of_pop){
  dir[i,1]<-str_trim(dir[i,1], side = c("right"))
}

library("dplyr")
library("stringr")
index<-0

for(i in 1:num_of_pop){
    index<-index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c(basename(dir[i,1]))
    if(index==1){
      all_feature_final<-all_features_names
    }else{
      all_feature_final<-rbind(all_feature_final,all_features_names)
      
    }
    #putting factor on the label
    all_feature_final$id<-as.factor(all_feature_final$id)
  }

#this part was problematic for the random forest
colnames(all_feature_final) <- make.names(colnames(all_feature_final))

all_feature_final %>% 
  count(id) %>% 
  mutate(prop = n/sum(n))
```

```{r}


library(randomForest)




mtry <- tuneRF(all_feature_final[-1],all_feature_final$id, ntreeTry=150,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)



set.seed(71)
rf <-randomForest(id~.,data=all_feature_final, mtry=best.m,
 importance=TRUE,ntree=150)
print(rf)
importance(rf)
varImpPlot(rf)


pred1=predict(rf,type = "prob")
library(ROCR)
perf = prediction(pred1[,2], all_feature_final$id)
# 1. Area under curve
auc = performance(perf, "auc")
auc
# 2. True Positive and Negative Rate
pred3 = performance(perf, "tpr","fpr")
# 3. Plot the ROC curve
plot(pred3,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")




```



```{r}
#install.packages("caTools")       # For sampling the dataset
#install.packages("randomForest")  # For implementing random forest algorithm
  
# Loading package
library(caTools)
library(randomForest)
  
# Splitting data in train and test data
split <- sample.split(all_feature_final, SplitRatio = 0.7)
split
  
train <- subset(all_feature_final, split == "TRUE")
test <- subset(all_feature_final, split == "FALSE")
  
# Fitting Random Forest to the train dataset
set.seed(120)  # Setting seed
classifier_RF = randomForest(x = train[-1],
                             y = train$id,
                             ntree = 600)
  
classifier_RF
  
# Predicting the Test set results
y_pred = predict(classifier_RF, newdata = test[-1])
  
# Confusion Matrix
confusion_mtx = table(test[, 1], y_pred)
confusion_mtx
  
# Plotting model
plot(classifier_RF)
  
# Importance plot
importance(classifier_RF)
  
# Variable importance plot
varImpPlot(classifier_RF)
```

