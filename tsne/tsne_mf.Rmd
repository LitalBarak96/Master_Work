---
title: "tsne_mf"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

#this chunk will creat combined_per_fly.csv
#note that combined_per_fly.csv does not include graph theory parametrs
#please also note this is taking time to calculate so please check first if you already have this file.
#needing also the dirs.xlsx that contain the list of dir you want to put together in combined_per_fly.csv (it is calculating the values per fly)
# ```{r}
# 
# require(R.matlab)
# library(base)
# library(openxlsx)
# library(igraph)
# library(ggplot2)
# library(cowplot)
# library(ggpubr)
# library(ggsignif)
# library(nortest)
# library(fmsb)
# library(argparser, quietly=TRUE)
# library(stringr)
# library("readxl")
# 
# 
#   library(openxlsx)
#   dirs <- as.data.frame(read.xlsx("F:/allGroups/dirs.xlsx"))
#   num_of_pop<<-nrow(dirs)
#   path_to_scripts<-"C:/Users/lital/OneDrive - Bar Ilan University/Lital/code/interactions_network/tsne/sub_function"
#   dir=as.data.frame(lapply(structure(.Data=1:1,.Names=1:1),function(x) numeric(num_of_pop)))
#   for (i in 1:num_of_pop){
#   dir[i,1]<-dirs$groupNameDir[i]
#   }
#   groupsNames <<- as.character(basename(dirs$groupNameDir))
#   #chnage the dir values so it would be readable
#   dir$X1<-gsub("\\\\", "/", dir$X1)
#   for(i in 1:num_of_pop){
#   dir[i,1]<-str_trim(dir[i,1], side = c("right"))
#   }
#   #### run the functions
#   setwd(path_to_scripts)
#   files.sources = list.files()
#   sapply(files.sources, source)
#   #### the actuall run (if the user choose to run from the start)
#   for (i in 1:num_of_pop){
#   #for each population i get the group name the number for movies and running 
#   setwd(dir[i,1])
#   avg_per_Fly_all_features(dir[i,1],path_to_scripts)
#   importClassifierFilesAndCalculatePerFrame(dir[i,1],path_to_scripts)
#   frq(dir[i,1],path_to_scripts)
#   }
# 
#   for(i in 1:num_of_pop){
#   #for each net there is different valus 
#   setwd(dir[i,1])
#   combind_all(dir[i,1],path_to_scripts)
#   }
#   
# ```


#this chunk creat the data set itself assuming we have combined_per_fly.csv that is created in random forest or in the pervous chunk
#in the color xlsx their is the color in rgb
#per male vs females

#tnse for male vs female
```{r}
#male vs female
  library(stringr)
  library(openxlsx)
  dirs <- as.data.frame(read.xlsx("F:/allGroups/dirs.xlsx"))
  num_of_pop<<-nrow(dirs)
  
    
  dir=as.data.frame(lapply(structure(.Data=1:1,.Names=1:1),function(x) numeric(num_of_pop)))
  for (i in 1:num_of_pop){
    dir[i,1]<-dirs$groupNameDir[i]
  }

groupsNames <<- as.character(basename(dirs$groupNameDir))

#chnage the dir values so it would be readable
dir$X1<-gsub("\\\\", "/", dir$X1)
for(i in 1:num_of_pop){
  dir[i,1]<-str_trim(dir[i,1], side = c("right"))
}




library("dplyr")
library("stringr")

#data frame that keep every group
Female<-data.frame()
Male<-data.frame()
#index for the first time inserting to the data frame we could do without rbind/bindrows 

Female_index<-0
Male_index<-0

for(i in 1:num_of_pop){
  if(str_detect(basename(dir[i,1]), "Females")){
    Female_index<-Female_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    #taking the movie name and calling it id
    colnames(all_features_names)<-c("id")
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("Female")
    #if the index is 1 we can't do rbind cuz the df is empty so we need to insert dirctly
    #we don't want to use bind_rows,it make problem with the colom names
    if(Female_index==1){
      Female<-all_features_names
    }else{
      #else the df is not empty and we can do rbind
      Female<-rbind(Female,all_features_names)
      
    }
    #putting factor on the label
    Female$id<-as.factor(Female$id)
  }
  
  ###the same for the male group
  #if the name contain the word males
  
  if(str_detect(basename(dir[i,1]), "Males")){
    Male_index<-Male_index+1
    setwd(dir[i,1])
    all_features<-read.csv("combined_per_fly.csv")
    #getting the colom names - getting the feature name e.g aggregation 
    feature_names<-all_features %>%
      select(starts_with('file'))
    #taking the first row of it and removing the col names
    names_data_frame<-as.data.frame(t(feature_names[1,]))
    rownames(names_data_frame)<-(NULL)
    colnames(names_data_frame)<-c("feature_name")
    #replace the feature names so they won't end with .mat ending
    names_data_frame$feature_name<- str_replace(names_data_frame$feature_name ,".mat", "")
    #converting them to list
    names_in_list<-as.list(names_data_frame$feature_name)
    all_features_names<-all_features$dir
    all_features_names<-as.data.frame(all_features_names)
    colnames(all_features_names)<-c("id")
    #taking the movie name and calling it id
    
    #taking only the values
    all_features_valus<-all_features %>%
      select(starts_with('valu'))
    #putting the name of the feature as colom name to the values
    colnames(all_features_valus)<-c(names_in_list)
    
    #connecting the names of the movies to the value and feature name
    all_features_names<-cbind(all_features_names,all_features_valus)
    all_features_names$id<-c("Male")
    
    if(Male_index==1){
      Male<-all_features_names
    }else{
      Male<-rbind(Male,all_features_names)
      
    }
    #putting factor on the label
    Male$id<-as.factor(Male$id)
  }
  
  
}

#after all we combainng them together
all_feature_final<-rbind(Female,Male)

#this part was problematic for the random forest
colnames(all_feature_final) <- make.names(colnames(all_feature_final))


#check balance
all_feature_final %>% 
  count(id) %>% 
  mutate(prop = n/sum(n))


#separting the data from the label so we could do scaling and than combein them together
actuall_data<-all_feature_final[,-1]

#scalng each colom to 1
scaled_dat <- data.frame(lapply(actuall_data, function(x) scale(x, center = FALSE, scale = max(x, na.rm = TRUE)/1)))
#putting the id in the first colom
scaled_dat<-cbind(all_feature_final$id,scaled_dat)
#changing it name to id
names(scaled_dat)[names(scaled_dat) == 'all_feature_final$id'] <- 'id'
library(readr)
library(Rtsne)
```


#doing defulat tsne
```{r male vs female tsne}
options(knitr.duplicate.label = "allow")

library(readr)
library(Rtsne)

colors = c("#00FF00","#FF0000")
names(colors)<-c("Male","Female")

## Run the t-SNE algorithm and store the results into an object called tsne_results
tsne_results <- Rtsne(scaled_dat[,-1], perplexity=30, check_duplicates = FALSE)
#THE DEFULAT IS 1000 ITERS
plot(tsne_results$Y, col = "black", bg= colors[scaled_dat$id], pch = 21, cex = 1.5)
#text(tsne_results$Y, labels=scaled_dat$id, col=colors[scaled_dat$id])
legend(x="topleft",legend = names(colors),fill=colors,cex=0.5)

```

#sampled tsne

```{r male vs female}
##ALSO WITH SAMPLING
numTrain <-nrow(scaled_dat)
set.seed(1)
rows <- sample(1:nrow(scaled_dat), numTrain)
train <- scaled_dat[rows,]

set.seed(1) # for reproducibility
tsne <- Rtsne(train[,-1], perplexity=30,check_duplicates = FALSE)

#colors = rainbow(length(unique(train$id)))
#names(colors) = unique(train$id)
plot(tsne$Y, main="tSNE sampled rows",col ="black", bg= colors[train$id],pch = 21, cex = 1.3)
#text(tsne$Y, labels=train$id, col=colors[train$id])
legend(x = "topleft",          # Position
       legend =names(colors),fill= colors,cex=0.5)
```

#cheking hyperparamters
```{r male vs female samples tsne}
library(Rtsne)

tsne_plot <- function(perpl=30,iterations=1000,learning=250){
  set.seed(1) # for reproducibility
  tsne <- Rtsne(train[,-1], dims = 2, perplexity=perpl, verbose=TRUE, max_iter=iterations, eta=learning)
  plot(tsne$Y, main = print(paste0("perplexity = ",perpl, ", max_iter = ",iterations, ", learning rate = ",learning)), col ="black", bg= colors[train$id],pch = 21, cex = 1.3 )
  legend(x = "topleft",          # Position
       legend =names(colors),fill= colors,cex=0.5)
  #text(tsne$Y, labels=train$id, col=colors[train$id],cex=0.5)
}

perplexity_values <- c(20,30,40,50,60,70,80,90)
sapply(perplexity_values,function(i){tsne_plot(perpl=i)})

learning_values <- c(20,200,300,2000)
sapply(learning_values,function(i){tsne_plot(learning=i)})

par(mfrow=c(3,3))
optPerp <- round(sqrt(104),0)
for(i in c( 200, 300, 500,1000,2000,3000,4000,5000,6000))
{
	tsne <- Rtsne(train[,-1],
		      perplexity=30, max_iter=i)
	plot(tsne$Y, col="blue", xlab="tSNE1", ylab="tSNE2", cex=0.5)
	mtext(paste0("max_iter = ", i))
}
```


